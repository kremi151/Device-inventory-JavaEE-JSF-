<!DOCTYPE html>
<html 
   xmlns="http://www.w3.org/1999/xhtml" 
   xmlns:h="http://java.sun.com/jsf/html"
   xmlns:b="http://bootsfaces.net/ui"
   xmlns:f="http://java.sun.com/jsf/core"
   xmlns:c="http://java.sun.com/jsp/jstl/core"
   xmlns:ui="http://java.sun.com/jsf/facelets" >
    <h:head>
        <title>Device information</title>
        <meta charset="utf-8"/>
        <script type="text/javascript">
        	function prepareModifyProperty(devId, id, name, type, value){
        		document.getElementById("modifyPropertyModalTarget").innerText = name;
        		document.getElementById("modifyPropertyModalType").innerText = type;
        		document.getElementById("modifyPropertyForm:devId").value = devId;
        		document.getElementById("modifyPropertyForm:propId").value = id;
        		document.getElementById("input_modifyPropertyForm:propValue").value = value;
        	}
        </script>
    </h:head>
    <h:body>
	    <ui:insert name="navbar" >
			<ui:include src="navbar.xhtml" />
		</ui:insert> 
		<b:container style="margin-top:70px">
			<c:set var="device" value="#{vdevice.getDeviceById(param['devid'])}" scope="request" />
			<ui:fragment rendered="#{device != null}">
				<c:set var="canRead" value="#{usession.canReadDevice(device)}" scope="request" />
				<c:set var="canModify" value="#{usession.canModifyDevice(device)}" scope="request" />
				<c:set var="canRemove" value="#{usession.canRemoveDevice(device)}" scope="request" />
				<c:set var="canIntervent" value="#{usession.canSubmitInterventions()}" scope="request" />
				
				<ui:fragment rendered="#{canRead}">
					<b:form id="modifyPropertyForm" rendered="#{canModify}">
						<b:modal class="modifyPropertyModal" title="Modify property">
							<p>Property: <strong><span id="modifyPropertyModalTarget"></span></strong></p>
							<p>Type: <strong><span id="modifyPropertyModalType"></span></strong></p>
							<h:inputHidden id="propId" value="#{vdevice.propId}" />
							<h:inputHidden id="devId" value="#{vdevice.devId}" />
							<b:inputText id="propValue" value="#{vdevice.propValue}" label="Value:" />
							<f:facet name="footer">
					            <b:button value="Cancel" dismiss="modal" />
					            <b:commandButton value="Apply" look="primary" action="#{vdevice.modifyProperty}" >
			        				<f:param name="devid" value="#{param['devid']}" />
			        			</b:commandButton>
					        </f:facet>
						</b:modal>
					</b:form>
					
					<b:form id="removeDeviceForm" rendered="#{canRemove}">
						<b:modal class="removeDeviceModal" title="Delete device">
							<h:inputHidden id="devId" value="#{vdevice.devId}" />
							<h:outputText value="The device #{device.name} of type #{device.type.name} owned by #{device.owner.firstName} #{device.owner.lastName} will be removed from the system. Do you want to continue?" />
							<f:facet name="footer">
					            <b:button value="No" look="primary" dismiss="modal" />
					            <b:commandButton value="Yes" action="#{vdevice.delete}" >
			        				<f:param name="devid" value="#{param['devid']}" />
			        			</b:commandButton>
					        </f:facet>
						</b:modal>
					</b:form>
					
					<b:form id="addInterventionForm" rendered="#{canIntervent}">
						<b:modal class="addInterventionModal" title="Post new intervention">
							<h:inputHidden id="devId" value="#{postintv.devId}" />
							<b:inputText id="intvTitle" value="#{postintv.title}" label="Title" />
							<b:inputText id="intvMsg" value="#{postintv.message}" label="Message" />
							<f:facet name="footer">
					            <b:button value="Cancel" look="primary" dismiss="modal" />
					            <b:commandButton value="Post" action="#{postintv.post}" >
			        				<f:param name="devid" value="#{param['devid']}" />
			        			</b:commandButton>
					        </f:facet>
						</b:modal>
					</b:form>
				
					<h1>#{device.name} <b:button value="Delete" icon="trash" size="sm" onclick="$('.removeDeviceModal').modal();" rendered="#{canRemove}" /></h1><h2>#{device.type.name}</h2><p>Owner: #{device.owner.firstName} #{device.owner.lastName}</p>
					<script type="text/javascript">document.title = '#{device.name}';</script>
					<ui:fragment rendered="#{canRemove}"><script type="text/javascript">document.getElementById("removeDeviceForm:devId").value = #{param['devid']};</script></ui:fragment>
					<ui:fragment rendered="#{canIntervent}"><script type="text/javascript">document.getElementById("addInterventionForm:devId").value = #{param['devid']};</script></ui:fragment>
					<b:messages />
					<b:accordion expanded-panels="panelProps">
						<b:panel id="panelProps" title="Properties">
							<b:dataTable value="#{vdevice.getPropertiesForDevice(device)}" var="prop">
			        			<b:dataTableColumn value="#{prop.property.name}" label="Property" />
			        			<b:dataTableColumn value="#{prop.value}" label="Value" />
			        			<b:dataTableColumn label="" orderable="false">
			        				<b:button onclick="prepareModifyProperty(#{param['devid']}, #{prop.property.id}, '#{prop.property.name}', '#{prop.property.type.description}', '#{prop.value}');$('.modifyPropertyModal').modal();" value="Modify" icon="pencil" disabled="#{not canModify}" />
			        			</b:dataTableColumn>
			        		</b:dataTable>
						</b:panel>
						<b:panel id="panelInterventions" title="Interventions">
							<b:button value="Add intervention" onclick="$('.addInterventionModal').modal();" icon="plus" size="sm" rendered="#{canIntervent}"/>
							<b:dataTable value="#{vdevice.getInterventions(device)}" var="intv">
								<b:dataTableColumn value="#{intv.date}" label="Date" style="width:15%;"/>
								<b:dataTableColumn value="#{intv.user.firstName} #{intv.user.lastName}" label="Responsible" style="width:15%;" /> 
								<b:dataTableColumn label="Content" style="width:70%;">
									<p><strong>#{intv.title}</strong></p>
									<p>#{intv.message}</p>
								</b:dataTableColumn>
							</b:dataTable>
						</b:panel>
					</b:accordion>
				</ui:fragment>
				<b:alert severity="danger" rendered="#{not canRead}">You do not have access to this information</b:alert>
			</ui:fragment>
			<b:alert severity="warning" rendered="#{device == null}">Unknown device</b:alert>
		</b:container>
    </h:body>
</html>